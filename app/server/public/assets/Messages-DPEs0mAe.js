import{j as s}from"./vendor-ui-K43rUeTs.js";import{r}from"./vendor-react-Dlyf-RJj.js";import{u as M,c as L,k as h}from"./index-CAGaxXNg.js";function $(){const{user:d}=M(),{showToast:w}=L(),[c,m]=r.useState([]),[a,v]=r.useState(null),[x,y]=r.useState([]),[n,f]=r.useState(""),[_,S]=r.useState(!0),[g,b]=r.useState(!1),j=r.useRef(null),N=r.useRef(null),o=r.useCallback(async()=>{try{const e=await h.list();m((e==null?void 0:e.data)||[])}catch(e){console.error("Failed to load conversations:",e)}finally{S(!1)}},[]),u=r.useCallback(async e=>{try{const t=await h.get(e);y((t==null?void 0:t.messages)||[]),m(i=>i.map(l=>l.id===e?{...l,unread_count:0}:l))}catch(t){console.error("Failed to load messages:",t)}},[]);r.useEffect(()=>{o()},[o]),r.useEffect(()=>{const e=()=>{o(),a&&u(a.id)};N.current=setInterval(e,3e4);const t=()=>e();return window.addEventListener("focus",t),()=>{clearInterval(N.current),window.removeEventListener("focus",t)}},[a,o,u]),r.useEffect(()=>{var e;(e=j.current)==null||e.scrollIntoView({behavior:"smooth"})},[x]);const E=async e=>{v(e),await u(e.id)},C=async e=>{if(e.preventDefault(),!(!n.trim()||!a)){b(!0);try{const t=await h.sendMessage(a.id,n.trim());y(i=>[...i,t.message]),f(""),m(i=>i.map(l=>l.id===a.id?{...l,last_message:n.trim(),last_message_at:new Date().toISOString()}:l))}catch{w("Failed to send message","error")}finally{b(!1)}}},p=c.reduce((e,t)=>e+(t.unread_count||0),0);return _?s.jsx("div",{className:"flex justify-center py-12",children:s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600"})}):s.jsxs("div",{children:[s.jsxs("div",{className:"mb-6",children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Messages"}),p>0&&s.jsxs("p",{className:"text-sm text-gray-600 mt-1",children:[p," unread message",p!==1?"s":""]})]}),s.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",style:{minHeight:"500px"},children:[s.jsxs("div",{className:"lg:col-span-1 bg-white rounded-lg shadow-sm overflow-hidden",children:[s.jsx("div",{className:"p-4 border-b bg-gray-50",children:s.jsx("h2",{className:"font-semibold text-gray-700",children:"Conversations"})}),s.jsx("div",{className:"divide-y divide-gray-200 max-h-[600px] overflow-y-auto",children:c.length===0?s.jsx("p",{className:"p-6 text-center text-gray-500",children:"No messages yet. Employers will contact you here when interested in your applications."}):c.map(e=>s.jsxs("div",{onClick:()=>E(e),className:`p-4 cursor-pointer transition-colors ${e.unread_count>0?"bg-blue-50":"hover:bg-gray-50"} ${(a==null?void 0:a.id)===e.id?"bg-gray-100 border-l-4 border-primary-600":""}`,children:[s.jsxs("div",{className:"flex items-start justify-between mb-1",children:[s.jsx("p",{className:"font-semibold text-sm text-gray-900",children:e.employer_name}),e.unread_count>0&&s.jsx("span",{className:"bg-blue-600 text-white text-xs rounded-full px-2 py-0.5",children:e.unread_count})]}),e.job_title&&s.jsxs("p",{className:"text-xs text-primary-600 mb-1",children:["Re: ",e.job_title]}),s.jsx("p",{className:"text-xs text-gray-500 truncate",children:e.last_message||"No messages yet"}),s.jsx("p",{className:"text-xs text-gray-400 mt-1",children:e.last_message_at?new Date(e.last_message_at).toLocaleDateString():""})]},e.id))})]}),s.jsx("div",{className:"lg:col-span-2 bg-white rounded-lg shadow-sm flex flex-col",children:a?s.jsxs(s.Fragment,{children:[s.jsxs("div",{className:"p-4 border-b bg-gray-50",children:[s.jsx("h2",{className:"font-semibold text-gray-900",children:a.employer_name}),a.job_title&&s.jsxs("p",{className:"text-sm text-primary-600",children:["Re: ",a.job_title]})]}),s.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-3 max-h-[450px]",children:[x.length===0?s.jsx("p",{className:"text-center text-gray-400 py-8",children:"No messages yet"}):x.map(e=>{const t=e.sender_id===(d==null?void 0:d.id);return s.jsx("div",{className:`flex ${t?"justify-end":"justify-start"}`,children:s.jsxs("div",{className:`max-w-[70%] rounded-lg px-4 py-2 ${t?"bg-primary-600 text-white":"bg-gray-100 text-gray-900"}`,children:[s.jsx("p",{className:"text-sm whitespace-pre-wrap",children:e.content}),s.jsx("p",{className:`text-xs mt-1 ${t?"text-primary-200":"text-gray-400"}`,children:new Date(e.created_at).toLocaleString()})]})},e.id)}),s.jsx("div",{ref:j})]}),s.jsxs("form",{onSubmit:C,className:"p-4 border-t flex gap-2",children:[s.jsx("input",{type:"text",value:n,onChange:e=>f(e.target.value),placeholder:"Type a message...",className:"flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary-500 focus:border-transparent",disabled:g}),s.jsx("button",{type:"submit",disabled:g||!n.trim(),className:"px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 disabled:opacity-50",children:g?"Sending...":"Send"})]})]}):s.jsx("div",{className:"flex-1 flex items-center justify-center text-gray-500",children:"Select a conversation to view messages"})})]})]})}export{$ as default};
